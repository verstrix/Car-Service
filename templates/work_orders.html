{% extends "base.html" %}
{% block content %}

<h3 class="mb-4">Work orders</h3>

<!-- CLIENT WORK ORDER FORM -->
{% if current_user.role == 'client' %}
<div class="card mb-4">
  <div class="card-body">
    <h5 class="mb-3">Create work order</h5>

    <form method="post">
      <div class="row g-3">

        <div class="col-md-4">
          <label class="form-label">Car Make</label>
          <input class="form-control" name="make" required>
        </div>

        <div class="col-md-4">
          <label class="form-label">Car Model</label>
          <input class="form-control" name="model" required>
        </div>

        <div class="col-md-2">
          <label class="form-label">Year</label>
          <input class="form-control" type="number" name="year">
        </div>

        <div class="col-md-4 mt-2">
          <label class="form-label">VIN (optional)</label>
          <input class="form-control" name="vin">
        </div>

        <div class="col-md-12 mt-2">
          <label class="form-label">Describe the problem</label>
          <textarea class="form-control" name="description" required></textarea>
        </div>

      </div>

      <button class="btn btn-primary mt-3" type="submit">Create</button>
    </form>
  </div>
</div>
{% endif %}

<!-- WORK ORDERS TABLE -->
<div class="card">
  <div class="card-body p-0">
    <table class="table table-hover table-striped mb-0">
      <thead class="table-dark">
        <tr>
          <th>ID</th>
          <th>Car</th>
          <th>Description</th>
          <th>Client</th>
          <th>Mechanic</th>
          <th>Status</th>
          <th style="width: 280px;">Actions</th>
        </tr>
      </thead>

      <tbody>
        {% for o in orders %}
        <tr>
          <td>
          <a href="{{ url_for('work_orders.view_order', order_id=o.id) }}">
            #{{ o.id }}
          </a>
        </td>


          <td>
            <a href="{{ url_for('cars.car_details', car_id=o.car.id) }}">
              {{ o.car.make }} {{ o.car.model }} ({{ o.car.year }})
            </a>
          </td>

          <td>{{ o.description }}</td>

          <td>{{ o.client.username }}</td>

          <td>{{ o.mechanic.username if o.mechanic else "-" }}</td>

          <td>{{ o.status.replace("_", " ") }}</td>

          <td>

            <!-- MANAGER ACTIONS -->
            {% if current_user.role == 'manager' %}

            <!-- Assign mechanic -->
            <form method="post" action="{{ url_for('work_orders.assign_mechanic', order_id=o.id) }}" class="d-flex mb-2">
              <select class="form-select form-select-sm me-2" name="mechanic_id">
                {% for m in mechanics %}
                  <option value="{{ m.id }}" {% if o.mechanic_id == m.id %}selected{% endif %}>
                    {{ m.username }}
                  </option>
                {% endfor %}
              </select>
              <button class="btn btn-sm btn-outline-primary">Assign</button>
            </form>

            <!-- Update status -->
            <form method="post" action="{{ url_for('work_orders.update_status', order_id=o.id) }}" class="d-flex">
              <select class="form-select form-select-sm me-2" name="status">
                <option value="open" {% if o.status == 'open' %}selected{% endif %}>Open</option>
                <option value="in_progress" {% if o.status == 'in_progress' %}selected{% endif %}>Working</option>
                <option value="awaiting_parts" {% if o.status == 'awaiting_parts' %}selected{% endif %}>Awaiting Parts</option>
                <option value="completed" {% if o.status == 'completed' %}selected{% endif %}>Completed</option>
              </select>
              <button class="btn btn-sm btn-success">Update</button>
            </form>

            {% endif %}

            <!-- MECHANIC ACTIONS -->
            {% if current_user.role == 'mechanic' and o.status != 'completed' %}
            <form method="post" action="{{ url_for('work_orders.complete_order', order_id=o.id) }}" class="d-flex">
              <select class="form-select form-select-sm me-2" name="part_id">
                <option value="">No part</option>
                {% for p in parts %}
                  <option value="{{ p.id }}">{{ p.name }} ({{ p.quantity }})</option>
                {% endfor %}
              </select>

              <input class="form-control form-control-sm me-2" type="number" name="quantity_used" placeholder="Qty">

              <button class="btn btn-sm btn-success">Complete</button>
            </form>
            {% endif %}

          </td>
        </tr>
        {% endfor %}
      </tbody>

    </table>
  </div>
</div>

{% endblock %}
